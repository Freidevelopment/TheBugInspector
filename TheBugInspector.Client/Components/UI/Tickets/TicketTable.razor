@inject IProjectDTOService ProjectService

@if (Ticket is not null)
{
    <!-- Item -->
    <div class="card d-sm-flex flex-sm-row align-items-sm-center card-hover justify-content-between bg-faded-info border-info shadow-sm p-3 p-md-4 mb-4 h-100">
        <div class="d-flex align-items-center pe-sm-3">
            <div class="ps-3 ps-sm-4">
                @if (Ticket.IsArchived == false)
                {
                    <h5 class="h5 mb-2">
                        <a class="mb-2 text-info" href="/tickets/Index/@Ticket.Id">@Ticket.Title</a>
                    </h5>


                }
                else
                {
                    <h5 class="h5 mb-2">
                        <a class="mb-2 text-info" href="/tickets/Index/@Ticket.Id">@Ticket.Title</a>
                    </h5>
                }

                @if (Ticket.Updated.HasValue)
                {
                    <div>Last Updated: @Ticket.Updated.Value.ToString("d")</div>
                }
                else
                {
                    <div>Last Updated: @Ticket.Created.ToString("d")</div>
                }

                <div>Project: @Ticket.Project.Name</div>
            <div class="vstack">
                <div>Priority: @Ticket.Priority.GetDisplayName()</div>
                <div>Type: @Ticket.Type.GetDisplayName()</div>
                <div>Status: @Ticket.Status.GetDisplayName()</div>

            </div>
            </div>
        </div>
    </div>

    @* <tr>
        <th scope="row"><a class="nav-link text-primary" href="/tickets/Index/@Ticket.Id"><u>@Ticket.Title</u></a></th>
        <td>@Ticket.Created.ToString("g")</td>
        @if (Ticket.Updated is not null)
        {
            <td>@Ticket.Updated.Value.ToString("D")</td>

        }
        else
        {
            <td>This Ticket has not been updated</td>
        }
        @if (project is not null)
        {
            <td>@project.Name</td>

        }
        <td>@Ticket.Priority.GetDisplayName()</td>
        <td>@Ticket.Status.GetDisplayName()</td>
        @if (Ticket.SubmitterUser is not null)
        {
            <td>@Ticket.SubmitterUser.FullName</td>

        }
        <td>@Ticket.Comments.Count()</td>
        <AuthorizeView>
            @if (project is not null && UserInfo is not null)
            {

                @if (context.User.IsInRole("Admin") || project.CompanyMembers.Any(c => c.UserId == UserInfo.UserId) && context.User.IsInRole("ProjectManager"))
                {
                    @if (Ticket.IsArchived is false)
                    {
                        <td><button class="btn btn-success" @onclick="HandleArchive">Archive</button></td>

                    }
                    else if (Ticket.IsArchived is true)
                    {
                        <td><button class="btn btn-success" @onclick="HandleRestore">Restore</button></td>
                    }

                }
            }
        </AuthorizeView>
    </tr> *@

}


@code {
    #region Parameters
    [Parameter, EditorRequired]
    public TicketDTO? Ticket { get; set; }

    [Parameter, EditorRequired]
    public UserInfo? UserInfo { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<int> OnRestore { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<int> OnArchive { get; set; }
    #endregion

    #region State
    private string? backgroundColor = string.Empty;
    private ProjectDTO? project;
    #endregion

    #region Methods
    protected override async Task OnParametersSetAsync()
    {
        if (Ticket is not null && UserInfo is not null)
        {
            project = await ProjectService.GetProjectByIdAsync(Ticket.ProjectId, UserInfo.CompanyId);

        }
    }
    private async Task HandleArchive()
    {
        if (Ticket is not null)
        {
            await OnArchive.InvokeAsync(Ticket.Id);

        }
    }
    private async Task HandleRestore()
    {
        if (Ticket is not null)
        {
            await OnRestore.InvokeAsync(Ticket.Id);

        }
    }
    #endregion
}

@page "/dashboard/Admin"
@using ApexCharts
@using TheBugInspector.Client.Components.UI.Charts
@using TheBugInspector.Client.Helpers

@inject ICompanyDTOService CompanyService
@inject IProjectDTOService ProjectService
@inject ITicketDTOService TicketService

@rendermode InteractiveAuto
@attribute [Authorize(Roles = $"{nameof(Roles.Admin)}")]

<PageTitle>BugInspector | Company Dashboard</PageTitle>

@if (userInfo is not null && user is not null && company is not null)
{
    <div class="container-xxl">
        <div class="row">
            <div class="col-2">
            </div>
            <div class="col-12 col-md-8">
                <!-- Primary background on hover -->
                <div class="card border-primary bg-faded-primary">
                    <div class="card-body">
                        <h5 class="card-title">Information: @userInfo.FullName</h5>
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <img src="@userInfo.ProfilePictureUrl" class="img-fluid rounded-circle" />
                            </div>
                            <div class="col-12 col-md-6">
                                <p class="card-text">Role:@user.Role</p>
                                <p class="card-text">Email: @userInfo.Email</p>
                                <a class="text-primary" href="/Account/Manage"><u>Manage Account</u></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-2">
            </div>
            <div class="col-12 col-md-4">

                <!-- Primary card -->
                <div class="card border-primary bg-faded-primary mt-3">
                    <div class="card-header border-primary text-primary">Active Tickets:</div>
                    <div class="card-body text-center">
                        <h1 class="card-title text-primary">@tickets.Count()</h1>
                        <a href="/tickets/active/Index" class=" text-end text-primary"><u>All active tickets</u></a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">

                <div class="card border-primary bg-faded-primary mt-3">
                    <div class="card-header border-primary text-primary">Active Projects:</div>
                    <div class="card-body text-center">
                        <h1 class="card-title text-primary">@projects.Count()</h1>
                        <a href="/projects/Index" class="text-end text-primary"><u>All Active Projects</u></a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">

                @* get rid of card only need link to company page*@
                <div class="card border-primary bg-faded-primary mt-3">
                    <div class="card-header border-primary text-primary">@company.Name: Employees</div>
                    <div class="card-body text-center">
                        <h1 class="card-title text-primary">@Members.Count()</h1>
                        <a href="/companies/Index" class=" text-end text-primary mt-3"><u>@company.Name page</u></a>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6">
                <div class="card border-primary bg-faded-primary mt-3">
                    <div class="card-header border-primary text-primary">Recent active Tickets</div>
                    <div class="card-body text-center">
                        <ul>
                            @foreach (TicketDTO ticket in recentActiveTickets)
                            {
                                <li class="list-item">
                                    <a class="text-primary" href="/tickets/Index/@ticket.Id"><u>@ticket.Title</u></a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="card border-primary bg-faded-primary mt-3">
                    <div class="card-header border-primary text-primary">Recent archived Tickets</div>
                    <div class="card-body text-center">
                        <ul>
                            @foreach (TicketDTO ticket in recentArchivedTickets)
                            {
                                <li class="list-item">
                                    <a class="text-primary" href="/tickets/Index/@ticket.Id"><u>@ticket.Title</u></a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
            @* <h1 class="text-center">Charts:</h1>
            <div class="col-12">

            </div> *@
        </div>
    </div>
}


@code {
    #region Parameters
    [CascadingParameter]
    private Task<AuthenticationState>? AuthStateTask { get; set; }
    #endregion

    #region State
    private CompanyDTO? company;
    private string? ErrorMessage = string.Empty;
    private IEnumerable<UserDTO> Members = [];
    private UserInfo? userInfo;
    private UserDTO? user;
    private IEnumerable<TicketDTO> tickets = [];
    private IEnumerable<TicketDTO> recentActiveTickets = [];
    private IEnumerable<TicketDTO> recentArchivedTickets = [];
    private IEnumerable<ProjectDTO> projects = [];
    #endregion

    #region Methods
    protected override async Task OnInitializedAsync()
    {
        try
        {
            userInfo = await UserInfoHelper.GetUserInfoAsync(AuthStateTask);

            if (userInfo is not null)
            {
                company = await CompanyService.GetCompanyByIdAsync(userInfo.CompanyId);
                Members = await CompanyService.GetCompanyMembersAsync(userInfo.CompanyId);
                tickets = await TicketService.GetAllTicketsAsync(userInfo.CompanyId);
                projects = await ProjectService.GetAllProjectsAsync(userInfo.CompanyId);
                user = Members.FirstOrDefault(m => m.UserId == userInfo.UserId);
                recentActiveTickets = await TicketService.GetMostRecentActiveTicketsAsync(userInfo.CompanyId);
                recentArchivedTickets = await TicketService.GetMostRecentArchivedTicketsAsync(userInfo.CompanyId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);

        }
    }


    
    #endregion
}
